<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEXGuessr</title>
    <style>
        :root {
            --apex-red: #DA292A;
            --apex-dark: #1e1e1e;
            --text-color: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.85);
        }
        body {
            margin: 0;
            background-color: var(--apex-dark);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- UI Components --- */
        button {
            background-color: var(--apex-red);
            color: white;
            border: none;
            padding: 12px 24px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: background-color 0.2s, transform 0.1s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        button:hover {
            background-color: #ff4444;
            transform: scale(1.02);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            background: linear-gradient(135deg, #1e1e1e 0%, #000000 100%);
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .active { display: flex; }

        /* --- Menu Screen --- */
        .menu-container {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--apex-red);
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 2px 2px 0px var(--apex-red);
        }
        .config-row {
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        select, input {
            padding: 10px;
            background: #333;
            color: white;
            border: 1px solid #555;
            font-size: 1rem;
            border-radius: 4px;
        }

        /* --- Game Screen Layout --- */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }
        
        /* Panorama View (Top) */
        #panorama-container {
            flex: 1;
            width: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
            border-bottom: 4px solid var(--apex-red);
            background: #000;
        }
        #panorama-container:active {
            cursor: grabbing;
        }
        #panorama-image {
            height: 100%;
            width: auto;
            position: absolute;
            top: 0;
            left: 0;
            user-select: none;
            pointer-events: none;
        }
        
        /* Map View (Bottom) */
        #map-container {
            flex: 1;
            width: 100%;
            position: relative;
            background: #111;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-map {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: crosshair;
            user-select: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Overlays */
        #map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--overlay-bg);
            padding: 15px 25px;
            border-radius: 4px;
            border-left: 3px solid var(--apex-red);
            pointer-events: none;
            z-index: 20;
            font-family: monospace;
            font-size: 1.2rem;
        }
        .map-name-label {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--overlay-bg);
            padding: 10px 20px;
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 20;
            border-right: 3px solid var(--apex-red);
        }

        #confirm-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 20;
            padding: 15px 40px;
            font-size: 1.2em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* Result Modal */
        #result-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.98);
            padding: 40px;
            border: 2px solid var(--apex-red);
            text-align: center;
            z-index: 100;
            display: none;
            min-width: 320px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .score-large { 
            font-size: 3.5em; 
            color: var(--apex-red); 
            font-weight: bold; 
            margin: 10px 0;
            font-family: 'Impact', sans-serif;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.2);
        }
        .info-text { font-size: 1.2em; margin-bottom: 20px; color: #ccc; }

        /* End Screen */
        .final-score-box {
            font-size: 5rem;
            font-weight: bold;
            color: var(--apex-red);
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen active">
        <h1>Apex GeoGuessr</h1>
        <div class="menu-container">
            <p>知識を試せ。チャンピオンを目指せ。</p>
            
            <div class="config-row">
                <label>MAP:</label>
                <select id="map-select"></select>
            </div>
            
            <div class="config-row">
                <label>ROUNDS:</label>
                <input type="number" id="round-count" value="5" min="1" max="10" style="width: 60px;">
            </div>
            
            <br>
            <button onclick="startGame()">DEPLOY</button>
            
            <p style="font-size: 0.8em; color: #888; margin-top:30px; line-height: 1.5;">
　　　　　　　画像は編集されたものであるため、編集跡が目立つことがあります。
            </p>
        </div>
    </div>

    <div id="game-screen">
        <div class="map-name-label" id="hud-map-name">MAP NAME</div>
        <div id="hud">
            ROUND: <span id="current-round">1</span> / <span id="total-rounds">5</span><br>
            SCORE: <span id="total-score">0</span>
        </div>

        <div id="panorama-container">
            <img id="panorama-image" src="" alt="View">
            <div style="position:absolute; bottom:15px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); padding:4px 15px; border-radius:20px; font-size:0.9em; pointer-events:none; border: 1px solid #555;">
                ◄ Drag to look around ►
            </div>
        </div>

        <div id="map-container">
            <img id="game-map" src="" alt="Map">
            <canvas id="map-overlay"></canvas>
            <button id="confirm-btn" onclick="submitGuess()" disabled>GUESS LOCATION</button>
        </div>

        <div id="result-modal">
            <h2 style="margin:0; text-transform:uppercase;">Round Result</h2>
            <div id="round-score-display" class="score-large">0</div>
            <div class="info-text">Distance: <span id="distance-display">0</span> px</div>
            <button onclick="nextRound()" id="next-btn">NEXT ROUND</button>
        </div>
    </div>

    <div id="end-screen" class="screen">
        <h1>GAME OVER</h1>
        <p>TOTAL SCORE</p>
        <div id="final-score" class="final-score-box">0</div>
        <button onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <script>
        // ==========================================
        //  USER CONFIGURATION (ここを編集してください)
        // ==========================================
        
        // 1. マップ設定
        // ID ("0", "1"など) に対応する「表示名」と「地図画像のファイル名」を設定します。
        // ※画像ファイルは maps フォルダに入れてください。
        const mapConfig = {
            "0": { name: "BrokenMoon", file: "0.png" },
            "1": { name: "World's Edge",  file: "1.png" },
            "2": { name: "Olympus",       file: "2.jpeg" }
            // 必要に応じて追加してください
        };

        // 2. 問題画像リスト
        // photos フォルダに入っているファイル名をすべて記述してください。
        // ファイル名は必ず「マップID_X座標_Y座標.拡張子」の形式にしてください。
        const photoFiles = [
            // 例 (適宜書き換えてください)
            // "0_1500_2500.jpg",
            // "0_3000_1000.png",
            // "1_200_4200.jpeg",
            "0_1955_1340.png",
            "0_2070_1685.jpg",
            "0_2302_2674.jpg",
            "0_3200_3153.jpg",
            "0_3775_1778.jpg"
        ];

        // ==========================================
        //  GAME LOGIC (ここから下は変更不要です)
        // ==========================================
        
        let gameState = {
            currentRound: 1,
            maxRounds: 5,
            totalScore: 0,
            mapId: null,
            questions: [],
            currentQ: null,
            guess: null,
            mapScale: 1
        };

        const MAP_SIZE = 5000; // マップの原寸サイズ

        // --- Initialization ---
        window.onload = () => {
            initMenu();
        };

        function initMenu() {
            const select = document.getElementById('map-select');
            
            // mapConfig にあるマップIDのみをリストアップ
            const availableMapIds = Object.keys(mapConfig);

            if(availableMapIds.length === 0) {
                const opt = document.createElement('option');
                opt.text = "Config Error: No Map Config";
                select.add(opt);
                return;
            }

            // マップ名でソートしてプルダウンに追加
            availableMapIds.sort().forEach(id => {
                const config = mapConfig[id];
                // そのマップIDに対応する問題があるかチェック（オプション）
                const hasQuestions = photoFiles.some(f => f.startsWith(id + '_'));
                
                if (hasQuestions) {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = config.name; // 表示名を使用
                    select.add(opt);
                }
            });

            if (select.options.length === 0) {
                 const opt = document.createElement('option');
                opt.text = "No questions found for config";
                select.add(opt);
            }
        }

        function startGame() {
            const mapId = document.getElementById('map-select').value;
            const rounds = parseInt(document.getElementById('round-count').value);

            // 選択されたマップIDで始まるファイルをフィルタリング
            const relevantFiles = photoFiles.filter(f => f.startsWith(mapId + '_'));
            
            if(relevantFiles.length === 0) {
                alert("このマップに対応する問題画像が見つかりません。");
                return;
            }

            // シャッフルして問題を選択
            const shuffled = relevantFiles.sort(() => 0.5 - Math.random());
            gameState.questions = shuffled.slice(0, Math.min(rounds, relevantFiles.length));
            
            gameState.mapId = mapId;
            gameState.maxRounds = gameState.questions.length;
            gameState.currentRound = 0;
            gameState.totalScore = 0;

            // UIセットアップ
            document.getElementById('menu-screen').classList.remove('active');
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('total-rounds').innerText = gameState.maxRounds;
            document.getElementById('hud-map-name').innerText = mapConfig[mapId].name;

            // マップ画像をロード
            const mapImg = document.getElementById('game-map');
            const mapFileName = mapConfig[mapId].file;
            mapImg.src = `maps/${mapFileName}`;
            
            nextRound();
        }

        // --- Round Logic ---
        function nextRound() {
            gameState.currentRound++;
            
            if(gameState.currentRound > gameState.maxRounds) {
                endGame();
                return;
            }

            // Reset UI
            gameState.guess = null;
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('confirm-btn').disabled = true;
            document.getElementById('confirm-btn').style.display = 'block';
            document.getElementById('current-round').innerText = gameState.currentRound;
            document.getElementById('total-score').innerText = gameState.totalScore;
            
            // Clear Canvas
            const canvas = document.getElementById('map-overlay');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Load Question
            const filename = gameState.questions[gameState.currentRound - 1];
            // ID_X_Y.ext をパース
            // 拡張子を除去
            const namePart = filename.substring(0, filename.lastIndexOf('.'));
            const parts = namePart.split('_');
            
            // parts[0] is ID, parts[1] is X, parts[2] is Y
            gameState.currentQ = {
                file: filename,
                x: parseInt(parts[1]),
                y: parseInt(parts[2])
            };

            // Setup Panorama Image
            const panoImg = document.getElementById('panorama-image');
            panoImg.src = `photos/${filename}`;
            panoImg.style.left = '0px';

            setupPanoDrag();
        }

        // --- Panorama Drag Logic (Mouse & Touch) ---
        function setupPanoDrag() {
            const container = document.getElementById('panorama-container');
            const img = document.getElementById('panorama-image');
            let isDown = false;
            let startX;
            let scrollLeft;

            const startDrag = (pageX) => {
                isDown = true;
                startX = pageX - container.offsetLeft;
                scrollLeft = parseInt(img.style.left || 0);
                container.style.cursor = 'grabbing';
            };

            const stopDrag = () => {
                isDown = false;
                container.style.cursor = 'grab';
            };

            const doDrag = (pageX, e) => {
                if(!isDown) return;
                e.preventDefault();
                const x = pageX - container.offsetLeft;
                const walk = (x - startX) * 1.5; // スクロール速度
                let newLeft = scrollLeft + walk;

                // 範囲制限 (画像がコンテナより小さい場合は動かさないなどの制御も可だが、今回はシンプルに)
                const minLeft = container.offsetWidth - img.offsetWidth;
                if (newLeft > 0) newLeft = 0;
                if (newLeft < minLeft) newLeft = minLeft;

                img.style.left = newLeft + 'px';
            };

            // Mouse Events
            container.addEventListener('mousedown', (e) => startDrag(e.pageX));
            container.addEventListener('mouseleave', stopDrag);
            container.addEventListener('mouseup', stopDrag);
            container.addEventListener('mousemove', (e) => doDrag(e.pageX, e));
            
            // Touch Events (スマホ対応)
            container.addEventListener('touchstart', (e) => startDrag(e.touches[0].pageX));
            container.addEventListener('touchend', stopDrag);
            container.addEventListener('touchmove', (e) => doDrag(e.touches[0].pageX, e));
        }

        // --- Map Interaction ---
        const mapElement = document.getElementById('game-map');
        const overlayCanvas = document.getElementById('map-overlay');

        const resizeObserver = new ResizeObserver(() => {
            if(mapElement.clientWidth > 0) {
                overlayCanvas.width = mapElement.clientWidth;
                overlayCanvas.height = mapElement.clientHeight;
                overlayCanvas.style.width = mapElement.clientWidth + 'px';
                overlayCanvas.style.height = mapElement.clientHeight + 'px';
                gameState.mapScale = mapElement.clientWidth / MAP_SIZE;
            }
        });
        resizeObserver.observe(mapElement);

        mapElement.addEventListener('click', (e) => {
            if(document.getElementById('result-modal').style.display === 'block') return;

            const rect = mapElement.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            // 画面上の座標を元の5000x5000座標に変換
            const realX = clickX / gameState.mapScale;
            const realY = clickY / gameState.mapScale;

            gameState.guess = { x: realX, y: realY };
            
            drawPin(clickX, clickY, false);
            document.getElementById('confirm-btn').disabled = false;
        });

        function drawPin(x, y, isAnswer) {
            const ctx = overlayCanvas.getContext('2d');
            if(!isAnswer) {
                // 回答フェーズでなければ、前のピンを消して描き直す
                ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            }
            
            const color = isAnswer ? '#2ecc71' : '#DA292A'; // 正解は緑、推測は赤

            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI, false);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'white';
            ctx.stroke();
        }

        function submitGuess() {
            if(!gameState.guess) return;

            const answerX = gameState.currentQ.x;
            const answerY = gameState.currentQ.y;
            
            // 距離計算
            const dist = Math.sqrt(
                Math.pow(gameState.guess.x - answerX, 2) + 
                Math.pow(gameState.guess.y - answerY, 2)
            );

            // スコア計算ロジック
            // 25px以内: 5000点
            // それ以降: 1pxごとに5点減点
            // 最小0点
            let score = 0;
            if (dist <= 25) {
                score = 5000;
            } else {
                score = 5000 - (dist - 25) * 5;
                if (score < 0) score = 0;
            }
            score = Math.floor(score);
            gameState.totalScore += score;

            // 結果表示
            const dispAnsX = answerX * gameState.mapScale;
            const dispAnsY = answerY * gameState.mapScale;
            const dispGuessX = gameState.guess.x * gameState.mapScale;
            const dispGuessY = gameState.guess.y * gameState.mapScale;

            drawPin(dispAnsX, dispAnsY, true); // 正解ピンを描画

            // 点線で結ぶ
            const ctx = overlayCanvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(dispGuessX, dispGuessY);
            ctx.lineTo(dispAnsX, dispAnsY);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);

            // モーダル表示
            const modal = document.getElementById('result-modal');
            document.getElementById('round-score-display').innerText = score;
            document.getElementById('distance-display').innerText = Math.floor(dist);
            document.getElementById('confirm-btn').style.display = 'none';
            
            const nextBtn = document.getElementById('next-btn');
            if(gameState.currentRound >= gameState.maxRounds) {
                nextBtn.innerText = "FINISH GAME";
            } else {
                nextBtn.innerText = "NEXT ROUND";
            }

            modal.style.display = 'block';
        }

        function endGame() {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = gameState.totalScore;
        }

    </script>
</body>
</html>
